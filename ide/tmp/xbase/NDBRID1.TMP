*******************************************************************************
FUNCTION ÛcTdbfÛTrn( cTrn ,cState ,lBreak ) ð // TRANSAZIONI ÛTrim(dd_dbf->FILE_DES)Û
*******************************************************************************
   .M->aTals   := {}
   .foreach tranpos
     .M->cTals := tDbfTrnTgt()
     .if Ascan( aTals ,{ |x| x == AllTrim(cTals) } ) == 0
        .aadd(  aTals ,AllTrim(cTals) )
     .endif
   .next
   .M->nTlen := Len(aTals)
   .if nTlen > 0
LOCAL  lRet      := .F.  ð //  Valore di ritorno funzione
STATIC aFile     := {}   ð //  Array dei file aperti dalla funzione
STATIC aFileLock := {}   ð //  Array dei lock sui file eseguiti dalla funzione
   .endif
.tPutInj( 0 ,[.inj TFF0] )

IF cTrn==NIL ;RETURN .F. ;END       ð // Tipo transazione non specificato

cTrn := Lower(cTrn)

DEFAULT cState  TO DE_STATE_INK
DEFAULT lBreak  TO .T.              ð // I tentativi di lock del record...
                                    ð // posson essere interrotti

BEGIN SEQUENCE

   .if nTlen > 0
      .M->nTcnt := 1
      .do while nTCnt  <= nTlen
      IF ! dfUse( "ÛaTals[nTcnt]Û" ,NIL ,aFile ) ;BREAK  ;END
         .M->nTCnt := nTcnt +1
      .enddo
   .endif
      .tPutInj( 7 ,[.inj TFF1] )

      IF     cTrn == "ltf"           ð // LOCK TRANSACTION FILE

   .if nTlen > 0
      .M->nTcnt := 1
      .do while nTCnt  <= nTlen
         IF ! ÛaTals[nTcnt]Û->(dfFileLock( aFileLock )) ;BREAK  ;END
         .M->nTCnt := nTcnt +1
      .enddo
   .endif

         lRet := .T.

      ELSEIF cTrn == "utf"           ð // UNLOCK TRANSACTION FILE

         lRet := .T.
         BREAK

      ELSEIF cTrn == "ltr"           ð // LOCK TRANSACTION RECORD

         .do Nltr

         lRet := .T.

      ELSEIF cTrn == "utr"           ð // UNLOCK TRANSACTION RECORD

         .do Nutr

         lRet := .T.
         BREAK

      ELSEIF cTrn == "ptt"           ð // PUT    THE TRANSACTION

         .tPutInj( 9 ,[.inj TFF2] )
         .do ptt
         .tPutInj( 9 ,[.inj TFF3] )

         lRet := .T.

      ELSEIF cTrn == "rtt"           ð // REMOVE THE TRANSACTION

         .tPutInj( 9 ,[.inj TFF4] )
         .do rtt
         .tPutInj( 9 ,[.inj TFF5] )

         lRet := .T.

      ELSEIF cTrn == "ltt"           ð // LOG    THE TRANSACTION

         .tPutInj( 9 ,[.inj TFF6] )
         .do ltt
         .tPutInj( 9 ,[.inj TFF7] )

         lRet := .T.

      ENDIF
      .tPutInj( 7 ,[.inj TFF8] )

RECOVER

   dfFileUnlock( aFileLock )   ð //  Sblocca i file bloccati dalla funzione
   dfClose( aFile, .T., .T. )  ð //  Chiude i file aperti in questa funzione

END

.tPutInj( 0 ,[.inj TFF9] )

RETURN lRet

